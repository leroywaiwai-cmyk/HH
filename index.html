import React, { useState, useMemo } from 'react';
import { 
  MapPin, 
  Calendar, 
  Clock, 
  Utensils, 
  Train, 
  Hotel, 
  Sun, 
  CloudSnow, 
  Cloud, 
  Info, 
  Phone, 
  CreditCard, 
  Plane, 
  ShoppingBag, 
  ChevronDown, 
  ChevronUp,
  Navigation,
  BookOpen,
  Coffee,
  Camera,
  AlertTriangle,
  CheckCircle,
  Briefcase,
  Thermometer,
  Trash2,
  Map as MapIcon,
  ExternalLink,
  PieChart as PieChartIcon,
  Mountain
} from 'lucide-react';

// --- Data Structure (Full Fidelity) ---

const tripData = {
  flights: [
    { type: 'Dep', code: 'HB008 (Â§ßÁÅ£ÂçÄËà™Á©∫)', route: 'HKG ‚Üí CTS', time: '09:15 - 15:00', date: '1/5 (‰∏Ä)', loc: 'HKG T1 7F Zone D', baggage: '20kg ÊâòÈÅã' },
    { type: 'Arr', code: 'HB009 (Â§ßÁÅ£ÂçÄËà™Á©∫)', route: 'CTS ‚Üí HKG', time: '16:00 - 21:15', date: '1/11 (Êó•)', loc: 'CTS International 3F', baggage: '20kg ÊâòÈÅã' }
  ],
  hotels: [
    { 
      name: 'VIA INN PRIME SAPPORO-ODORI', 
      dates: '1/5 - 1/8 (3Êôö)', 
      loc: 'VIA INN PRIME SAPPORO-ODORI', 
      address: 'Êú≠ÂπåÂ∏Ç‰∏≠Â§ÆÂå∫Âçó1Êù°Ë•ø2‰∏ÅÁõÆ9-1',
      note: 'Â§ßÊµ¥Â†¥„ÄåÈà¥Ëò≠‰πãÊπØ„Äç / 19:00 Check-in',
      price: 'JPY 20,136'
    },
    { 
      name: 'ÂÆöÂ±±Ê∫™Á¨¨‰∏ÄÂØ∂‰∫≠Áïô Áø†Â±±‰∫≠', 
      dates: '1/8 - 1/9 (1Êôö)', 
      loc: 'Jozankei Daiichi Hotel Suizantei', 
      address: 'Êú≠ÂπåÂ∏ÇÂçóÂå∫ÂÆöÂ±±Ê∏ìÊ∏©Ê≥âË•ø3‰∏ÅÁõÆ105',
      note: 'ÊàøÂûãÔºöÂ±ïÊúõÈ¢®ÂëÇ‰ªòÂíåÈ¢®Êàø (75„é°) / ‰∏ÄÊ≥ä‰∫åÈ£ü',
      price: 'JPY 68,200'
    },
    { 
      name: 'KOKO HOTEL Sapporo Susukino', 
      dates: '1/9 - 1/11 (2Êôö)', 
      loc: 'KOKO HOTEL Sapporo Susukino', 
      address: 'Êú≠ÂπåÂ∏Ç‰∏≠Â§ÆÂå∫Âçó7Êù°Ë•ø5‰∏ÅÁõÆ1-7',
      note: 'ÊàøÂûãÔºöDeluxe Twin (26„é°) / ÂåÖÊó©È§ê',
      price: 'JPY 28,192'
    }
  ],
  contacts: [
    { title: 'Êó•Êú¨Á∑äÊÄ•Â†±Ë≠¶', num: '110' },
    { title: 'ÁÅ´Ë≠¶/ÊïëË≠∑Ëªä', num: '119' },
    { title: 'Â§ñ‰∫§ÈÉ®ÊóÖÂ§ñÊÄ•Èõ£ÊïëÂä©', num: '+81-80-1009-7179' } 
  ],
  days: [
    {
      id: 1,
      date: '1/5 (‰∏Ä)',
      title: 'Êú≠ÂπåÊäµÈÅîÊó•',
      weather: 'snow',
      temp: '-3¬∞C / -8¬∞C',
      highlight: 'Âè™Êãé‰ªäÊôöÁî®ÂìÅ (‰∏ç unpack)',
      summary: 'ÁßªÂãïÊó•Ôºå‰øùÊåÅÈ´îÂäõÔºåÊôöÈ§ê Plan A/B/C„ÄÇ',
      events: [
        { time: '06:45', type: 'transport', title: 'Âá∫ÁôºÂéªÊ©üÂ†¥', desc: 'ÁöÑÂ£´ ‚Üí È¶ôÊ∏ØÂúãÈöõÊ©üÂ†¥ 1 ËôüÂÆ¢ÈÅãÂ§ßÊ®ìÔΩú7 Ê®ì D ÂçÄ', loc: 'Hong Kong International Airport' },
        { time: '09:15', type: 'transport', title: 'È£õË°å HB008', desc: '09:15 HKG ‚Üí 15:00 CTS (Êñ∞ÂçÉÊ≠≤)', loc: 'New Chitose Airport' },
        { time: '18:00', type: 'transport', title: 'Ê©üÂ†¥Â∑¥Â£´ÊäµÈÅî', desc: 'ËêΩËªäÈªûÔºöÂçó3Êù°„Åô„Åô„Åç„ÅÆ (Susukino)\nÁ¥Ñ 18:00‚Äì18:30 ÊäµÈÅî', loc: 'Minami 3 Jo Susukino Bus Stop' },
        { 
          time: '18:30', 
          type: 'hotel', 
          title: 'Check-in', 
          desc: 'VIA INN PRIME SAPPORO-ODORI\n‚ùå ‰∏ç unpack\n‚úî Âè™Êãé‰ªäÊôöÔºãÊòéÊó•Áî®ÂìÅ', 
          loc: 'VIA INN PRIME SAPPORO-ODORI' 
        },
        { 
          time: '19:00', 
          type: 'food', 
          title: 'ÊôöÈ§ê (19:00-20:00)', 
          desc: 'Ê≠•Ë°å 2‚Äì6 ÂàÜÈêòÂÖßÔºåÂÖ®Âú®ÈÖíÂ∫óÈôÑËøë„ÄÇ',
          plans: [
             { label: 'Plan A (ÊúÄÁ©©Èô£)', text: 'ÊùæÂ±ã Êú≠ÂπåÂçó3Êù°Â∫ó (Ê≠•Ë°å2-3ÂàÜ)„ÄÇÁâõ‰∏º/ÂÆöÈ£ü„ÄÇÂá∫È§êÂø´„ÄÅÁÜ±„ÄÅÂîî‰ΩøÁ≠â„ÄÇÈï∑ÈÄîÊ©üÂæåÈ¶ñÈÅ∏„ÄÇ', loc: 'Matsuya Sapporo Minami 3-jo' },
             { label: 'Plan B (Ê∏ÖÊ∑°)', text: '„Å™„ÅãÂçØ „Åô„Åô„Åç„ÅÆÂ∫ó (Ê≠•Ë°å3-4ÂàÜ)„ÄÇË¶™Â≠ê‰∏º„ÄÅÁÉèÂÜ¨„ÄÇÊØîËºÉÊöñËÉÉ„ÄÅÂîîÊ≤π„ÄÇ', loc: 'Nakau Susukino' },
             { label: 'Plan C (ÂêçÁâ©)', text: '„Çπ„Éº„Éó„Ç´„É¨„Éº GARAKU (Ê≠•Ë°å5-6ÂàÜ)„ÄÇÊπØÂíñÂñ±„ÄÇ‚ö†Ô∏è Âè™Èôê„ÄåÂÜáÊéíÈöäÊàñÊéí ‚â§10 ‰∫∫„Äç„ÄÇ', loc: 'Soup Curry GARAKU' }
          ],
          warning: 'üö´ Á¨¨‰∏ÄÊôö‰∏çÂª∫Ë≠∞ÊàêÂêâÊÄùÊ±ó/ÊéíÈöäÂ£ΩÂè∏ÔºåÁïôËøîÁ≤æÁ•ûÂ•ΩÂÖàÈ£ü„ÄÇ',
          loc: 'Matsuya Sapporo Minami 3-jo' 
        },
        { time: '20:30', type: 'relax', title: 'Â§ßÊµ¥Â†¥„ÄåÈà¥Ëò≠‰πãÊπØ„Äç', desc: '20:30-21:30 Êµ∏ÊπØ\n22:30 Ââç‰∏äÂ∫ä‰ºëÊÅØ', loc: 'VIA INN PRIME SAPPORO-ODORI' }
      ]
    },
    {
      id: 2,
      date: '1/6 (‰∫å)',
      title: 'Â∏ÇÂÖßËßÄÂÖâÔºãÁáíËÇâÔºãËó•Â¶ù',
      weather: 'cloudy',
      temp: '-2¬∞C / -7¬∞C',
      highlight: 'ÁáíËÇâ #18552 / Ëó•Â¶ù‰∏ÄÊ¨°ÁµêÂ∏≥',
      summary: '‰∫åÊù°Â∏ÇÂ†¥ ‚Üí ÂåóÂ§ß ‚Üí ÊπØÂíñÂñ± ‚Üí ÁáíËÇâ ‚Üí Ëó•Â¶ùÊéÉË≤®',
      events: [
        { time: '08:30', type: 'food', title: 'Êó©È§êÔºöÈ≠öÂ±ã„ÅÆÂè∞ÊâÄ', desc: 'Âà•ÈÇ∏„Éª‰∫åÊù°Â∏ÇÂ†¥„ÅÆ„Çå„ÇìÊ®™‰∏ÅÂ∫ó\nÊµ∑ÈÆÆÊó©È§êÔºå‰ªΩÈáèÂîîÈáç', loc: 'Uoya no Daidokoro' },
        { time: '09:20', type: 'sight', title: '‰∫åÊù°Â∏ÇÂ†¥Êï£Ê≠•', desc: '09:20‚Äì10:00', loc: 'Nijo Market' },
        { time: '10:30', type: 'sight', title: 'ÂåóÊµ∑ÈÅìÂ§ßÂ≠∏', desc: '10:30‚Äì12:00\nÊ†°ÂúíÈõ™ÊôØ„ÄÅÂπ≥Ë∑ØÂ§öÔºåÂîîÊî∞', loc: 'Hokkaido University' },
        { 
          time: '12:30', 
          type: 'food', 
          title: 'ÂçàÈ§êÔºöSuage+ Êú¨Â∫ó', 
          desc: '12:30‚Äì13:30 ÊπØÂíñÂñ±\n‚Ä¢ Ëæ£Â∫¶Ôºöüå∂Ô∏è 1‚Äì2\n‚Ä¢ È£ØÈáèÔºöüçö Â∞ëÔºèÂçä‰ªΩ\n‚Ä¢ ÈÖçÊñôÔºöÈõûËÇâ Êàñ ÈáéËèú\n‚ùå ÈÅøÂÖçÁÇ∏Áâ©„ÄÅÂä†È£Ø (ÂîîÂΩ±ÈüøÊôöÈ§ê)', 
          mustEat: 'Áü•Â∫äÈõûËÇâÊπØÂíñÂñ±',
          loc: 'Suage+ Sapporo' 
        },
        { time: '13:45', type: 'sight', title: 'ËàäÈÅìÂª≥Á¥ÖÁ£ö', desc: '13:45‚Äì14:15\nÊãçÁÖßÂç≥ÂèØÔºåÂîî‰πÖÁïô', loc: 'Former Hokkaido Government Office' },
        { time: '14:30', type: 'food', title: '‰∏ãÂçàÁîúÈªûÔºöÈõ™Âç∞„Éë„Éº„É©„Éº', desc: 'Êú≠ÂπåÊú¨Â∫ó\nüëâ Âë¢ÊÆµ‰øÇ‰ºëÊÅØÔºåÂîîÁï∂Ê≠£È§ê', loc: 'Snow Brand Parlor Sapporo' },
        { time: '15:45', type: 'sight', title: 'Êú≠ÂπåÂï§ÈÖíÂçöÁâ©È§®', desc: '15:45‚Äì16:45\nÂèÉËßÄÁÇ∫‰∏ªÔºåÈ£≤ÈÖíÂèØÂÖç', loc: 'Sapporo Beer Museum' },
        { time: '16:55', type: 'hotel', title: 'ÂõûÈÖíÂ∫óÊ∫ñÂÇô', desc: 'Êîæ‰ΩéÂ§ñÂ•óÔºèË¢ã\n‚ö†Ô∏è Â∏∂Ë≠∑ÁÖßÔºãÈå¢ÂåÖÔºàÂ§úÊôöËó•Â¶ùË¶ÅÁî®Ôºâ', loc: 'VIA INN PRIME SAPPORO-ODORI' },
        { 
          time: '17:15', 
          type: 'food', 
          title: 'ÊôöÈ§êÔºöÁÑºËÇâÂæ≥ÂØø K-Place', 
          desc: '17:15‚Äì18:45 (È†êÁ¥ÑÊôÇÊÆµ)', 
          reservation: 'È†êÁ¥ÑÁ∑®ËôüÔºö#18552\nÈ†êÁ¥ÑÂßìÂêçÔºöLeroy Lei\nÂ∫ß‰ΩçÔºöTable Seat',
          warning: '‚ö†Ô∏è È£üÂà∞ 7‚Äì8 ÊàêÈ£ΩÂç≥ÂèØÔºåÂ§úÊôö‰ª≤Ë¶ÅË°å',
          loc: 'Yakiniku Tokuju K-Place' 
        },
        { 
          time: '19:00', 
          type: 'shopping', 
          title: 'Ëó•Â¶ù‰∏ªÊà∞Â†¥', 
          desc: 'Âú∞ÈªûÔºö„ÉÄ„Ç§„Ç≥„ÇØ„Éâ„É©„ÉÉ„Ç∞ (Daikoku) Êú≠ÂπåÂçó2Êù°Â∫ó\nÂè™ÁµêÂ∏≥‰∏ÄÊ¨°ÔºåÁî®ÂÖçÁ®ÖÔºãÈ°çÂ§ñÊäòÊâ£Âà∏\n¬•5,000 ‚Üí 13% OFF\n¬•30,000 ‚Üí 15% OFF\n¬•50,000 ‚Üí 18% OFF (MAX)', 
          loc: 'Daikoku Drug Sapporo Minami 2-jo' 
        },
        { time: '20:30', type: 'hotel', title: 'ÂõûÈÖíÂ∫óÊï¥ÁêÜ', desc: 'Âç∏Èáç„ÄÅÊï¥ÁêÜÊà∞Âà©ÂìÅ„ÄÅÈ£≤Ê∞¥„ÄÅ‰ºëÊÅØ\n22:30 Ââç‰∏äÂ∫ä (ÁøåÊó•Â∞èÊ®Ω)', loc: 'VIA INN PRIME SAPPORO-ODORI' }
      ]
    },
    {
      id: 3,
      date: '1/7 (‰∏â)',
      title: 'Â∞èÊ®ΩÔºãÂ§©ÁãóÂ±±‰∏ÄÊó•ÈÅä',
      weather: 'snow',
      temp: '-4¬∞C / -9¬∞C',
      highlight: 'Â§©ÁãóÂ±±Á∫úËªä / ‰∏âËßíÂ∏ÇÂ†¥ / Âåó‰∏ÄÁ°ùÂ≠ê',
      summary: '‰∏äÂ±±ÁùáÈõ™ÊôØ ‚Üí ËêΩÂ±±È£üÊµ∑ÈÆÆ ‚Üí ÈÅãÊ≤≥Êï£Ê≠• ‚Üí ÁÖ§Ê≤πÁáàÂíñÂï° ‚Üí Ê¥ãÈ£üÊôöÈ§ê',
      events: [
        { 
          time: '08:30', 
          type: 'food', 
          title: 'Êó©È§êÔºö„Ç≥„É°„ÉÄÁèàÁê≤Â∫ó', 
          desc: 'Áã∏Â∞èË∑Ø‰∫å‰∏ÅÁõÆÂ∫ó\nÂíñÂï°ÔºãÂéöÂ§öÂ£´ÔºèÁ∞°ÂñÆ‰∏âÊñáÊ≤ª\nüëâ ÂîîÂ•ΩÂ§™ÈáçÔºåÁïôËÇöÈ£üÊµ∑ÈÆÆÔºã‰πãÂæåÊ¥ªÂãï\nÈ£üÂÆåÂç≥ÂàªËøîÈÖíÂ∫óÂü∑Âò¢Âá∫Áôº', 
          loc: 'Komeda Coffee Tanukikoji' 
        },
        { time: '09:45', type: 'transport', title: 'JR Êú≠Âπå ‚Üí Â∞èÊ®Ω', desc: '09:45‚Äì10:45 (ËªäÁ®ã 45 mins)\nJR ÂáΩÈ§®Êú¨Á∑ö\nüëâ 10:45‚Äì11:00 ÊäµÈÅîÂ∞èÊ®Ω', loc: 'Sapporo Station' },
        { 
          time: '11:05', 
          type: 'sight', 
          title: 'Â§©ÁãóÂ±± (ÈáçÈªûÂ∑≤Èéñ)', 
          desc: '‰∫§ÈÄöÔºöÂ∞èÊ®ΩÁ´ôÂâçÂ∑¥Â£´Á∏ΩÁ´ô (9/10ËôüÂ∑¥Â£´)\nËêΩËªäÔºöÂ§©ÁãóÂ±±„É≠„Éº„Éó„Ç¶„Çß„Ç§ (ÁµÇÈªû)\nË°åÁ®ãÔºöÁ∫úËªä‰æÜÂõû + ËßÄÊôØÂΩ±Áõ∏ (1.5-2Â∞èÊôÇ)',
          warning: 'Â±±È†ÇÈ¢®Â§ßÔºåÂ∏ΩÔºãÊâãÂ•óÂøÖÈ†à„ÄÇËÉΩË¶ãÂ∫¶Â∑ÆÂ∞±Á∏ÆÁü≠ÂÅúÁïô„ÄÇ', 
          loc: 'Otaru Tenguyama Ropeway' 
        },
        { 
          time: '13:45', 
          type: 'food', 
          title: 'ÂçàÈ§êÔºöÊæ§Â¥éÊ∞¥Áî£3Âè∑Â∫ó', 
          desc: '13:45‚Äì15:00 @ ‰∏âËßíÂ∏ÇÂ†¥\nÊµ∑ÈÆÆ‰∏º (È£ü 7‚Äì8 ÊàêÈ£Ω)\nÊµÅËΩâÂø´ÔºåÂîî‰ΩøÁ≠âÂ•ΩËÄê\nüëâ ‰∏äÂÆåÂ±±ÂÖàÈ£üÊµ∑ÈÆÆÔºåÈ´îÂäõÂêåËÉÉÂè£ÈÉΩÂï±‰Ωç', 
          mustEat: 'ÁâπÈÅ∏Êµ∑ÈÆÆ‰∏º',
          loc: 'Sankaku Market Otaru' 
        },
        { time: '15:10', type: 'sight', title: 'Â∞èÊ®ΩÈÅãÊ≤≥ (Áü≠ÂÅú)', desc: '15:10‚Äì16:45 (Âê´Â†∫Áî∫ÈÄö)\n15-20 mins ÈÅãÊ≤≥ÂΩ±Èõ™ÊôØ', loc: 'Otaru Canal' },
        { 
          time: '15:30', 
          type: 'shopping', 
          title: 'Â†∫Áî∫ÈÄöÊÖ¢Ë°å', 
          desc: 'ÂÖ≠Ëä±‰∫≠ (Â§ñÂ∏∂ÊúÄÁ©©) / ÂåóËèìÊ•º\nÂ∞èÊ®Ω„Ç™„É´„Ç¥„Éº„É´Â†Ç / Âåó‰∏ÄÁ°ùÂ≠ê\nüëâ ÂéüÂâáÔºöÊØèÈñì ‚â§15 ÂàÜÈêòÔΩúÂîîÊéíÈöäÔΩúÂáçÂ∞±Âç≥Ëµ∞', 
          loc: 'Sakaimachi Street' 
        },
        { 
          time: '16:45', 
          type: 'coffee', 
          title: '‰∏ãÂçàËå∂ÔºöÂåó‰∏Ä„Éõ„Éº„É´', 
          desc: '16:45‚Äì17:30\nÁÖ§Ê≤πÁáàÂ§ßÂª≥ÔºåÂÜ¨Â§©Ê∞£Ê∞õÊÑüÊ•µÈ´ò\nüëâ ÂÆåÂÖ®Âèñ‰ª£ LeTAO ÊéíÈöä', 
          loc: 'Kitaichi Hall' 
        },
        { 
          time: '17:45', 
          type: 'food', 
          title: 'ÊôöÈ§êÔºöOtaru Bine', 
          desc: '17:45‚Äì19:00\nÊ¥ãÈ£üÔºãËë°ËêÑÈÖí\n‰ΩúÁÇ∫Â∞èÊ®ΩÊó•Êî∂Â∞æÈùûÂ∏∏ÁêÜÊÄß', 
          loc: 'Otaru Bine' 
        },
        { time: '19:15', type: 'transport', title: 'JR ËøîÊú≠Âπå', desc: '19:15‚Äì20:15\nËøîÈÖíÂ∫óÊµ∏Èà¥Ëò≠‰πãÊπØ', loc: 'Otaru Station' },
        { time: '20:30', type: 'relax', title: 'Pack Ë°åÊùé', desc: 'ÁÇ∫ 1/8 ÂÆöÂ±±Ê∫™ËΩâÂÆøÂÅöÊ∫ñÂÇô\n22:30 Ââç‰∏äÂ∫ä', loc: 'VIA INN PRIME SAPPORO-ODORI' }
      ]
    },
    {
      id: 4,
      date: '1/8 (Âõõ)',
      title: 'Êú≠Âπå ‚Üí ÂÆöÂ±±Ê∫™Ê∫´Ê≥â',
      weather: 'snow',
      temp: '-5¬∞C / -10¬∞C',
      highlight: 'ÈÄÅËøéÂ∑¥Â£´ 11:30 / ÊàøÂÖßÈ¢®ÂëÇ / Êá∑Áü≥ÊñôÁêÜ',
      summary: 'ËΩâÂÆøÊó•ÔºöÊó©È§ê ‚Üí Â∑¥Â£´ ‚Üí Ê∫´Ê≥âÊóÖÈ§®ÊîæÈ¨Ü',
      events: [
        { time: '08:30', type: 'relax', title: 'Ê¢≥Ê¥óÔºèÊî∂Êãæ', desc: 'ÊúÄÂæåÊï¥ÁêÜË°åÊùé\nËëóÂ•Ω‰ªäÊó•ËΩâÂÆøÁî®ÂòÖ‰øùÊöñË°£Áâ©', loc: 'VIA INN PRIME SAPPORO-ODORI' },
        { time: '09:30', type: 'food', title: 'Êó©È§êÔºö„Ç≥„É°„ÉÄÁèàÁê≤Â∫ó', desc: 'Áã∏Â∞èË∑Ø‰∫å‰∏ÅÁõÆÂ∫ó\nÂéöÂ§öÂ£´Ôºè‰∏âÊñáÊ≤ªÔºãÁÜ±ÂíñÂï°\nÂÆö‰ΩçÔºöËΩâÂÆøÊó•ÊúÄÂÆâÂÖ®Êó©È§ê', loc: 'Komeda Coffee Tanukikoji' },
        { 
          time: '10:30', 
          type: 'hotel', 
          title: 'ÈÄÄÊàø Checkout', 
          desc: 'VIA INN PRIME ÈÄÄÊàø\nË°åÊùéË∑üË∫´Ôºö30Âêã√ó1„ÄÅ27.6Âêã√ó1„ÄÅ21Âêã√ó1', 
          loc: 'VIA INN PRIME SAPPORO-ODORI' 
        },
        { 
          time: '10:50', 
          type: 'transport', 
          title: 'ÁöÑÂ£´ ‚Üí Â∑¥Â£´ÈõÜÂêàÈªû', 
          desc: 'ÁõÆÁöÑÂú∞ÔºöÂú∞‰∏ãÈêµ Â§ßÈÄöÁ´ô Âá∫Âè£ 1\nÂ§ßÈÄöË•ø 5 ‰∏ÅÁõÆ„ÉªÊò≠Âíå„Éì„É´Ââç\n11:00 ÂâçË¶ÅÂà∞ÈÅî', 
          loc: 'Odori Nishi 5-chome' 
        },
        { 
          time: '11:30', 
          type: 'transport', 
          title: 'ÈÄÅËøéÂ∑¥Â£´„ÄåÊπØ„Åë„ÇÄ„ÇäÂè∑„Äç', 
          desc: 'Ê∫ñÊôÇÂá∫Áôº (‚ë†)\nË°åÊùéÊîæËªäÂ∫ïÔºåËªä‰∏ä‰ºëÊÅØ\nÁ¥Ñ 12:40 ÊäµÈÅîÂÆöÂ±±Ê∫™', 
          loc: 'Odori Nishi 5-chome' 
        },
        { time: '12:45', type: 'sight', title: 'Check-in ÂâçÊï£Ê≠•', desc: 'Âè™ÊèÄ 1 ÂÄãÔºöÂÆöÂ±±Ê∫êÊ≥âÂÖ¨Âúí Êàñ ‰∫åË¶ãÂêäÊ©ã\nÂéüÂâáÔºöÂîîË°åÂ§ö„ÄÅÂîîÊî∞„ÄÅÂîîË∂ï', loc: 'Jozankei Gensen Park' },
        { time: '15:00', type: 'hotel', title: 'ÂÖ•‰Ωè Áø†Â±±‰∫≠', desc: 'ÂÆöÂ±±Ê∫™Á¨¨‰∏ÄÂØ∂‰∫≠Áïô Áø†Â±±‰∫≠\nÊàøÂûãÔºö75„é° Â±ïÊúõÈ¢®ÂëÇ‰ªòÂíåÈ¢®Êàø\nÂÖ•Êàø„ÄÅÊîæË°åÊùé„ÄÅÊèõÊµ¥Ë°£', loc: 'Jozankei Daiichi Hotel Suizantei' },
        { time: '15:30', type: 'relax', title: 'Ê∫´Ê≥â (Á¨¨‰∏ÄÂõûÂêà)', desc: 'ÊàøÂÖßÂ±ïÊúõÈ¢®ÂëÇ (Âº∑ÁÉàÂª∫Ë≠∞) Êàñ Â§ßÊµ¥Â†¥', loc: 'Jozankei Daiichi Hotel Suizantei' },
        { 
          time: '18:00', 
          type: 'food', 
          title: 'ÊôöÈ§êÔºö‰∏ÄÊ≥ä‰∫åÈ£ü', 
          desc: '6,000 ÂÜÜ„Ç≥„Éº„Çπ\n‰∏ªËèúÔºö„ÇΩ„Ç§„ÅÆË™øÁêÜÊ≥ï ‚Üí „ÅäÈÄ†„ÇäÔºàÂà∫Ë∫´Ôºâ\nÂÜ¨Â≠£ÂåóÊµ∑ÈÅìÈ´òÁ¥öÁôΩË∫´È≠ö', 
          loc: 'Jozankei Daiichi Hotel Suizantei' 
        },
        { time: '20:00', type: 'relax', title: 'Ê∫´Ê≥â (Á¨¨‰∫åÂõûÂêà)', desc: 'ÂÜçÊµ∏‰∏ÄÊ¨°ÔºåÊàøÈñì‰ºëÊÅØ\n22:30 Ââç‰∏äÂ∫äËÅΩÊ∫™Ê∞¥ËÅ≤Áûì', loc: 'Jozankei Daiichi Hotel Suizantei' }
      ]
    },
    {
      id: 5,
      date: '1/9 (‰∫î)',
      title: 'ÂÆöÂ±±Ê∫™ ‚Üí Êú≠Âπå (ÊãâÈ∫µÊó•)',
      weather: 'cloudy',
      temp: '-2¬∞C / -6¬∞C',
      highlight: 'Áâ©Áî¢È§® / 13:00 Â∑¥Â£´ / ‰∏ÄÁ≤íÂ∫µ',
      summary: 'Êô®Êµ¥ ‚Üí Êâã‰ø° ‚Üí ÂõûÊú≠Âπå ‚Üí ‰æøÂà©Â∫óËºïÈ£ü ‚Üí ‰∏ÄÁ≤íÂ∫µÊãâÈ∫µ',
      events: [
        { time: '07:30', type: 'relax', title: 'Êô®Êµ¥ + Êó©È§ê', desc: 'ÊàøÂÖßÂ±ïÊúõÈ¢®ÂëÇ (ÊúÄÂæå‰∏ÄÊµ∏)\n08:30 ÊóÖÈ§®Êó•ÂºèÊó©È§ê (È£ü 7 ÊàêÈ£Ω)', loc: 'Jozankei Daiichi Hotel Suizantei' },
        { time: '11:00', type: 'hotel', title: 'Check-out', desc: 'Ë°åÊùé‰∫§‰øæÊóÖÈ§® (Á®çÂæå‰∏äËªä)', loc: 'Jozankei Daiichi Hotel Suizantei' },
        { time: '11:05', type: 'shopping', title: 'ÂÆöÂ±±Ê∫™Áâ©Áî£È§®', desc: '‰∏≠Â§ÆÂ∫ó (Ë≤∑Êâã‰ø°)', loc: 'Jozankei Bussankan' },
        { time: '11:35', type: 'food', title: 'ÁîúÂìÅÔºöJ.glac√©e', desc: '„Åµ„ÇãÂ∑ù ÊûúÊó• (Ê∏ÖÁàΩÈõ™Ëë©ÔºèÈõ™Á≥ï)', loc: 'J.glacee Jozankei' },
        { time: '12:30', type: 'transport', title: 'Á≠âÂ∑¥Â£´', desc: 'ÂõûÂà∞ÊóÖÈ§®ÈñÄÂè£ÔºåÊ∫ñÂÇô 13:00 ‰∏äËªä', loc: 'Jozankei Daiichi Hotel Suizantei' },
        { time: '13:00', type: 'transport', title: 'ÂõûÁ®ãÂ∑¥Â£´', desc: 'ÊπØ„Åë„ÇÄ„ÇäÂè∑ (‚ë°) Âá∫Áôº\n14:10‚Äì14:20 ÊäµÈÅîÊú≠Âπå (Â§ßÈÄö‰∏ÄÂ∏∂)', loc: 'Jozankei Daiichi Hotel Suizantei' },
        { 
          time: '14:20', 
          type: 'transport', 
          title: 'ÁöÑÂ£´ ‚Üí KOKO HOTEL', 
          desc: 'Èõ™Âú∞Ôºã‰∏â‰ª∂Ë°åÊùéÔºåÁöÑÂ£´ÊúÄÁ©©\n14:40 Check-inÔºèÂØÑÂ≠òË°åÊùé', 
          loc: 'KOKO HOTEL Sapporo Susukino' 
        },
        { 
          time: '15:30', 
          type: 'food', 
          title: 'ÈÅ≤ÂçàÈ§ê (ËºïÈ£ü)', 
          desc: 'Âú∞ÈªûÔºöKOKO HOTEL ÈôÑËøë‰æøÂà©Â∫ó/Ë∂ÖÂ∏Ç\nË≤∑È£ØÁ≥∞„ÄÅÊ≤ôÂæã„ÄÅÁÜ±È£≤\nüëâ ÂéüÂâáÔºöÁúü„ÉªÂ¢äÂ∫ïÈ§êÔΩúÂîîÂùêÈ§êÂª≥ÔΩúÂîîÊãñÊôÇÈñì', 
          mustEat: '‰æøÂà©Â∫óÈ£ØÁ≥∞',
          loc: 'KOKO HOTEL Sapporo Susukino' 
        },
        { time: '16:15', type: 'shopping', title: 'Áü≠ÊÆµ Shopping', desc: 'ËñÑÈáéÔºèÂ§ßÈÄöÂú∞‰∏ãË°ó\nÂ∞ëÈáèËó•Â¶ùË£úË≤∑„ÄÅDonki quick look', loc: 'Sapporo Underground Pedestrian Space' },
        { 
          time: '18:30', 
          type: 'food', 
          title: 'ÊôöÈ§êÔºö‰∏ÄÁ≤íÂ∫µ', 
          desc: '„É©„Éº„É°„É≥Êú≠Âπå‰∏ÄÁ≤íÂ∫µ\nÊú≠ÂπåÂë≥ÂôåÊãâÈ∫µ\nÂ∞èÊèêÁ§∫Ôºö18:00‚Äì18:15 Âà∞ÔºåÁ≠â‰ΩçËºÉÂ∞ë', 
          mustEat: 'Êú≠ÂπåÂë≥ÂôåÊãâÈ∫µ',
          loc: 'Ramen Sapporo Ichiryuan' 
        },
        { time: '19:45', type: 'hotel', title: 'ÂõûÈÖíÂ∫ó‰ºëÊÅØ', desc: 'Ê¥óË°´ÔºèÊï¥ÁêÜË°åÊùé\nÁÇ∫ 1/10 shopping Êó•ÂÅöÊ∫ñÂÇô', loc: 'KOKO HOTEL Sapporo Susukino' }
      ]
    },
    {
      id: 6,
      date: '1/10 (ÂÖ≠)',
      title: 'Shopping + ÊãÖÊãÖÈ∫µ',
      weather: 'snow',
      temp: '-3¬∞C / -8¬∞C',
      highlight: 'Donki 10:30 / Ê†πÂÆ§Ëä±‰∏∏ / 175¬∞DENO',
      summary: 'Donki ‚Üí Â£ΩÂè∏ ‚Üí Loft ‚Üí ÁîúÈªû ‚Üí ÊãÖÊãÖÈ∫µ ‚Üí Packing',
      events: [
        { time: '08:30', type: 'food', title: 'Êó©È§ê (ÈÖíÂ∫ó)', desc: 'È£üÂà∞ 7 ÊàêÈ£Ω (Áïô‰ΩçÈ£üÂ£ΩÂè∏)', loc: 'KOKO HOTEL Sapporo Susukino' },
        { 
          time: '10:30', 
          type: 'shopping', 
          title: 'Donki ÊéÉË≤®', 
          desc: '„Éâ„É≥„Éª„Ç≠„Éõ„Éº„ÉÜ Êú≠ÂπåÁã∏Â∞èË∑ØÊú¨Â∫ó\nÁ≠ñÁï•ÔºöÂÖàË≤∑Ëó•Â¶ùÂ§ß‰ª∂„ÄÅÈõ∂È£ü„ÄÅÈáçÁâ©\nË°åÂÆåÂèØÂÖàËøîÈÖíÂ∫óÊîæ‰Ωé (Ëøë)', 
          loc: 'Don Quijote Sapporo Tanukikoji' 
        },
        { 
          time: '12:30', 
          type: 'food', 
          title: 'ÂçàÈ§êÔºöÊ†πÂÆ§Ëä±‰∏∏', 
          desc: 'COCONO SUSUKINOÂ∫ó\nÈ£ØÂèØÂ∞ëÈáè„ÄÅÈÅøÂÖçÁÇ∏Áâ© (ÊôöÈ§êÊãâÈ∫µ)', 
          loc: 'COCONO SUSUKINO' 
        },
        { time: '14:30', type: 'food', title: '‰∏ãÂçàËå∂Ôºö„Åç„ÅÆ„Å®„ÇÑ', desc: 'Â§ßÈÄöÂÖ¨ÂúíÂ∫ó„ÉªKINOTOYA cafe\nËäùÂ£´ÊíªÔºèÂ∞è‰ª∂ËõãÁ≥ïÔºãÁÜ±È£≤', loc: 'KINOTOYA Odori Park' },
        { time: '15:30', type: 'shopping', title: 'Loft ËºïË≥ºÁâ©', desc: 'ÊñáÂÖ∑„ÄÅÊóÖË°åÂ∞èÁâ©„ÄÅÊâÅÂπ≥ÈõúË≤®\nüëâ Âè™Ë≤∑ ËºïÔºãÊòì pack', loc: 'Sapporo Loft' },
        { time: '16:45', type: 'hotel', title: 'Êîæ‰ΩéÊà∞Âà©ÂìÅ', desc: 'Ëøî KOKO HOTEL Êîæ‰ΩéÂò¢\nüëâ ÊôöÈ§êÂâçÂîîÊèπÈáçÁâ©', loc: 'KOKO HOTEL Sapporo Susukino' },
        { 
          time: '18:30', 
          type: 'food', 
          title: 'ÊôöÈ§êÔºö175¬∞DENO', 
          desc: '175¬∞DENOÊãÖÊãÖÈ∫µ\nËæ£Â∫¶Ôºö2‚Äì3 (ÊúâÈ¶ôÂë≥ÂîîÁàÜ)\nÈ∫ªÂ∫¶ÔºöÊôÆÈÄö / È∫µÔºöÂéüÂë≥\nüëâ ÁÜ±„ÄÅÂø´„ÄÅÊöñË∫´ÔºåÈ£üÂÆåÂç≥ËøîÈÖíÂ∫ó Packing', 
          mustEat: 'ÊãÖÊãÖÈ∫µ',
          loc: '175¬∞DENO Ramen Lounge' 
        },
        { 
          time: '19:30', 
          type: 'hotel', 
          title: 'Packing (ÊúÄÂæå‰∏ÄÊôö)', 
          desc: 'Ë°åÊùé 80‚Äì90% pack ÂÆå\nÂàÜÂ•ΩÔºöÂØÑËâôÔºèÊâãÊèê\nÊ™¢Êü•Ê∂≤È´î„ÄÅÈáçÈáè', 
          loc: 'KOKO HOTEL Sapporo Susukino' 
        }
      ]
    },
    {
      id: 7,
      date: '1/11 (Êó•)',
      title: 'ËøîÁ®ãÊó•',
      weather: 'sun',
      temp: '-4¬∞C / -8¬∞C',
      highlight: 'ÂúãÂÖßÁ∑öÂçàÈ§ê (GARAKU) / 11:00 Checkout',
      summary: 'Checkout ‚Üí JR ‚Üí Ê©üÂ†¥ÂúãÂÖßÁ∑öÂçàÈ§ê ‚Üí ÂúãÈöõÁ∑ö Check-in',
      events: [
        { time: '08:30', type: 'food', title: 'Êó©È§ê (ÈÖíÂ∫ó)', desc: 'È£üÂà∞ 6‚Äì7 ÊàêÈ£Ω\nÁïô‰ΩçÂéªÊ©üÂ†¥È£üÊπØÂíñÂñ±', loc: 'KOKO HOTEL Sapporo Susukino' },
        { time: '09:30', type: 'hotel', title: 'ÊúÄÂæåÊï¥ÁêÜ', desc: 'Ê∂≤È´îÔºèËÜèÁãÄÁâ© ‚Üí ÊâòÈÅã\nË≠∑ÁÖß„ÄÅÁôªÊ©üÊñá‰ª∂ ready', loc: 'KOKO HOTEL Sapporo Susukino' },
        { time: '11:00', type: 'hotel', title: 'Check-out', desc: 'ÊãéÈΩä‰∏â‰ª∂Ë°åÊùéÔºåÁõ¥Êé•Âá∫Áôº (ÂîîÂØÑÂ≠ò)', loc: 'KOKO HOTEL Sapporo Susukino' },
        { time: '11:00', type: 'transport', title: 'ÁöÑÂ£´ ‚Üí JR Êú≠ÂπåÁ´ô', desc: 'ÂÜ¨Â§©ÔºãÂ§öË°åÊùéÔºåÁ©©ÂÆöÂÑ™ÂÖà', loc: 'Sapporo Station' },
        { time: '12:00', type: 'transport', title: 'JR Rapid Airport', desc: '12:00‚Äì12:37 (ÊåáÂÆöÂ∏≠)\nÈÅøÈñãËá™Áî±Â∏≠Ë°åÊùéÈ¢®Èö™', loc: 'Sapporo Station' },
        { time: '12:37', type: 'transport', title: 'ÊäµÈÅîÊñ∞ÂçÉÊ≠≤ (ÂúãÂÖßÁ∑ö)', desc: 'ÂúãÂÖßÁ∑öÂà∞ÈÅîÂ±§', loc: 'New Chitose Airport Domestic Terminal' },
        { 
          time: '12:45', 
          type: 'food', 
          title: 'ÂçàÈ§êÔºöGARAKU Ê©üÂ†¥Â∫ó', 
          desc: 'Âú∞ÈªûÔºöÂúãÂÖßÁ∑öËà™Âªà\nËæ£Â∫¶Ôºö1‚Äì2 / È£ØÈáèÔºöÂ∞ë\n‚ùå ÈÅøÂÖçÁÇ∏Áâ©ÔºèÂä†È£Ø\nüëâ È£üÂÆåÂÖàÂéªÂúãÈöõÁ∑öÔºåÂãïÁ∑öÊúÄÈ†Ü', 
          mustEat: 'ÈõûËÇâ/ÈáéËèúÊπØÂíñÂñ±',
          loc: 'GARAKU New Chitose Airport' 
        },
        { time: '13:40', type: 'transport', title: 'ÂúãÈöõÁ∑ö Check-in', desc: '3F ÂúãÈöõÁ∑öÂá∫Áôº\nCheck-inÔºãÊâòÈÅã (13:00‚Äì15:00)', loc: 'New Chitose Airport International Terminal' },
        { time: '14:10', type: 'shopping', title: 'Ë°åÊ©üÂ†¥', desc: 'ÂÖçÁ®ÖÔºèÊâã‰ø°Ôºè‰ºëÊÅØ', loc: 'New Chitose Airport' },
        { time: '16:00', type: 'transport', title: 'Ëµ∑È£õ ‚úàÔ∏è', desc: 'HB009 ËøîÊ∏Ø', loc: 'New Chitose Airport' }
      ]
    }
  ]
};

// --- Components ---

const WeatherIcon = ({ type }) => {
  if (type === 'sun') return <Sun className="w-5 h-5 text-amber-500" />;
  if (type === 'snow') return <CloudSnow className="w-5 h-5 text-blue-300" />;
  return <Cloud className="w-5 h-5 text-gray-400" />;
};

const CategoryIcon = ({ type }) => {
  switch (type) {
    case 'food': return <Utensils className="w-4 h-4" />;
    case 'transport': return <Train className="w-4 h-4" />;
    case 'hotel': return <Hotel className="w-4 h-4" />;
    case 'sight': return <Camera className="w-4 h-4" />;
    case 'shopping': return <ShoppingBag className="w-4 h-4" />;
    case 'coffee': return <Coffee className="w-4 h-4" />;
    case 'relax': return <Thermometer className="w-4 h-4" />;
    default: return <Clock className="w-4 h-4" />;
  }
};

const SectionHeader = ({ icon, title }) => (
  <h3 className="text-xs font-bold text-stone-400 uppercase tracking-wider mb-3 flex items-center gap-2 mt-6 first:mt-0">
    {icon} {title}
  </h3>
);

// Configuration for Categories
const CATEGORY_CONFIG = {
  food: { label: 'È£≤È£ü', color: '#fb923c', icon: Utensils }, // Orange
  shopping: { label: 'Ë≥ºÁâ©', color: '#f472b6', icon: ShoppingBag }, // Pink
  hotel: { label: '‰ΩèÂÆø', color: '#a78bfa', icon: Hotel }, // Purple
  transport: { label: '‰∫§ÈÄö', color: '#60a5fa', icon: Train }, // Blue
  flight: { label: 'Ê©üÁ•®', color: '#38bdf8', icon: Plane }, // Sky
  other: { label: 'ÂÖ∂‰ªñ', color: '#9ca3af', icon: Clock }, // Gray
};

export default function HokkaidoTripAppFull() {
  const [activeTab, setActiveTab] = useState('itinerary');
  const [openDay, setOpenDay] = useState(1); 
  const [mapLocation, setMapLocation] = useState("Sapporo Station"); 
  
  const EXCHANGE_RATE = 0.050; 

  const [expenses, setExpenses] = useState([
    { id: 1, title: 'Day 1 ÊôöÈ§êÈ†êÁÆó', amount: 3000, cat: 'food' },
    { id: 2, title: 'Day 2 Ëó•Â¶ùÈ†êÁÆó', amount: 50000, cat: 'shopping' },
    // Updated food budgets (Removed Crab & Wagyu, added Ramen)
    { id: 3, title: 'Day 5 ‰∏ÄÁ≤íÂ∫µÊãâÈ∫µ', amount: 2500, cat: 'food' }, 
    { id: 4, title: 'Day 6 175¬∞DENO', amount: 2500, cat: 'food' },
    { id: 5, title: '‰ΩèÂÆø: VIA INN PRIME', amount: 20136, cat: 'hotel' },
    { id: 6, title: '‰ΩèÂÆø: Áø†Â±±‰∫≠ (‰∏ÄÊ≥ä‰∫åÈ£ü)', amount: 68200, cat: 'hotel' },
    { id: 7, title: '‰ΩèÂÆø: KOKO HOTEL', amount: 28192, cat: 'hotel' },
  ]);
  const [newExpTitle, setNewExpTitle] = useState('');
  const [newExpAmount, setNewExpAmount] = useState('');
  const [newExpCategory, setNewExpCategory] = useState('food'); // Default Category
  const [newExpCurrency, setNewExpCurrency] = useState('JPY'); // Default Currency

  const handleAddExpense = () => {
    if(!newExpTitle || !newExpAmount) return;
    
    let finalAmount = parseInt(newExpAmount);
    
    // Auto convert HKD to JPY
    if (newExpCurrency === 'HKD') {
        finalAmount = Math.round(finalAmount / EXCHANGE_RATE);
    }

    setExpenses([...expenses, { 
      id: Date.now(), 
      title: newExpTitle, 
      amount: finalAmount, // Store as JPY
      cat: newExpCategory 
    }]);
    setNewExpTitle('');
    setNewExpAmount('');
  };

  const handleDeleteExpense = (id) => {
    setExpenses(expenses.filter(ex => ex.id !== id));
  };

  const totalBudget = 300000; 
  const currentSpent = expenses.reduce((acc, curr) => acc + curr.amount, 0);
  const formatHKD = (yen) => `HK$${Math.round(yen * EXCHANGE_RATE).toLocaleString()}`;

  // Pie Chart Logic
  const chartData = useMemo(() => {
    const totals = {};
    Object.keys(CATEGORY_CONFIG).forEach(key => totals[key] = 0);
    expenses.forEach(ex => {
      const cat = ex.cat || 'other';
      if (totals[cat] !== undefined) totals[cat] += ex.amount;
      else totals['other'] += ex.amount;
    });

    let cumulativePercent = 0;
    
    return Object.entries(totals)
      .filter(([_, amount]) => amount > 0)
      .map(([key, amount]) => ({
        key,
        amount,
        ...CATEGORY_CONFIG[key],
        percent: (amount / currentSpent) * 100
      }))
      .sort((a, b) => b.amount - a.amount)
      .map((cat) => {
        // Calculate position for icon
        const startPercent = cumulativePercent;
        const endPercent = cumulativePercent + cat.percent;
        const midPercent = (startPercent + endPercent) / 2;
        cumulativePercent = endPercent;
        
        return {
          ...cat,
          midPercent // 0-100 scale for positioning
        };
      });
  }, [expenses, currentSpent]);

  const pieGradient = useMemo(() => {
    if (currentSpent === 0) return 'conic-gradient(#e5e7eb 0% 100%)';
    let gradientStr = 'conic-gradient(';
    let currentPercent = 0;
    chartData.forEach((cat, index) => {
      const start = currentPercent;
      const end = currentPercent + cat.percent;
      gradientStr += `${cat.color} ${start}% ${end}%${index < chartData.length - 1 ? ', ' : ''}`;
      currentPercent = end;
    });
    gradientStr += ')';
    return gradientStr;
  }, [chartData, currentSpent]);

  // Helper functions...
  const openMap = (loc) => {
    if (!loc) return;
    window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(loc)}`);
  };

  const handleLocClick = (loc) => {
    setMapLocation(loc);
    const mapContainer = document.getElementById('map-preview-container');
    if (mapContainer) mapContainer.scrollIntoView({ behavior: 'smooth' });
  };

  return (
    <div className="flex justify-center min-h-screen bg-stone-200 font-sans text-stone-800">
      <div className="w-full max-w-md bg-stone-50 shadow-2xl overflow-hidden flex flex-col h-[100vh] sm:h-[95vh] sm:rounded-3xl sm:my-4 border-stone-300 sm:border">
        
        {/* Header */}
        <header className="bg-white border-b border-stone-200 p-4 sticky top-0 z-30 shadow-sm">
          <div className="flex justify-between items-center">
            <div>
              <h1 className="text-lg font-black tracking-widest text-stone-800">HOKKAIDO</h1>
              <p className="text-[10px] text-stone-500 font-bold uppercase tracking-wider">2026.01.05 - 01.11 | Full Itinerary</p>
            </div>
            <div className="text-right">
              <div className="text-[10px] text-stone-400 font-bold uppercase">Budget Used</div>
              <div className="text-sm font-bold font-mono text-stone-700">¬•{currentSpent.toLocaleString()}</div>
            </div>
          </div>
        </header>

        {/* Main Content */}
        <main className="flex-1 overflow-y-auto pb-24 scrollbar-hide bg-stone-100/50">
          
          {/* --- ITINERARY TAB --- */}
          {activeTab === 'itinerary' && (
            <div className="space-y-3 p-3">
              {tripData.days.map((day) => (
                <div key={day.id} className="bg-white rounded-xl shadow-sm border border-stone-200 overflow-hidden">
                  
                  {/* Card Header */}
                  <div 
                    onClick={() => setOpenDay(openDay === day.id ? null : day.id)}
                    className={`p-4 flex items-center justify-between cursor-pointer transition-colors ${openDay === day.id ? 'bg-stone-50' : 'bg-white'}`}
                  >
                    <div className="flex items-center gap-4">
                      <div className={`flex flex-col items-center justify-center w-12 h-12 rounded-lg border ${openDay === day.id ? 'bg-stone-800 text-white border-stone-800' : 'bg-white text-stone-800 border-stone-200'}`}>
                        <span className="text-xs font-bold uppercase">{day.date.split(' ')[1].replace(/[()]/g,'')}</span>
                        <span className="text-lg font-black">{day.date.split('/')[1].split(' ')[0]}</span>
                      </div>
                      <div>
                        <h3 className="font-bold text-stone-800">{day.title}</h3>
                        <div className="flex items-center gap-2 mt-1">
                          <WeatherIcon type={day.weather} />
                          <span className="text-xs text-stone-500 font-mono">{day.temp}</span>
                        </div>
                      </div>
                    </div>
                    {openDay === day.id ? <ChevronUp size={20} className="text-stone-400"/> : <ChevronDown size={20} className="text-stone-300"/>}
                  </div>

                  {/* Highlight Bar (Closed State) */}
                  {openDay !== day.id && (
                    <div className="px-4 pb-3 pt-0">
                      <div className="text-xs text-stone-500 line-clamp-1 pl-1 border-l-2 border-stone-300">
                        {day.summary}
                      </div>
                    </div>
                  )}

                  {/* Expanded Content */}
                  {openDay === day.id && (
                    <div className="bg-stone-50 border-t border-stone-100">
                      {/* Day Highlight Box */}
                      <div className="bg-blue-50/50 p-3 text-xs text-blue-800 font-medium border-b border-blue-100 flex gap-2 items-start">
                        <Info size={14} className="shrink-0 mt-0.5" />
                        {day.highlight}
                      </div>

                      <div className="p-4 relative">
                        {/* Timeline Line */}
                        <div className="absolute left-[27px] top-4 bottom-4 w-0.5 bg-stone-200" />

                        {day.events.map((event, idx) => (
                          <div key={idx} className="relative pl-8 mb-6 last:mb-0">
                            {/* Timeline Dot */}
                            <div className={`absolute left-0 top-1 w-6 h-6 rounded-full border-2 border-white shadow-sm flex items-center justify-center z-10 ${
                              event.type === 'food' ? 'bg-orange-100 text-orange-600' : 
                              event.type === 'transport' ? 'bg-blue-100 text-blue-600' : 
                              event.type === 'hotel' ? 'bg-purple-100 text-purple-600' :
                              'bg-stone-200 text-stone-600'
                            }`}>
                              <CategoryIcon type={event.type} />
                            </div>

                            {/* Content Block */}
                            <div className="bg-white p-3.5 rounded-lg border border-stone-200 shadow-sm">
                              {/* Header: Time + Nav */}
                              <div className="flex justify-between items-start mb-2">
                                <span className="font-mono text-sm font-black text-stone-800 bg-stone-100 px-1.5 py-0.5 rounded">
                                  {event.time}
                                </span>
                                <button 
                                  onClick={(e) => { e.stopPropagation(); openMap(event.loc); }}
                                  className="text-stone-300 hover:text-blue-500 active:text-blue-600 transition-colors p-1 -mr-1 -mt-1"
                                >
                                  <Navigation size={16} />
                                </button>
                              </div>

                              <h4 className="font-bold text-base text-stone-900 mb-1">{event.title}</h4>
                              
                              {/* Description with Line Breaks Preserved */}
                              <div className="text-sm text-stone-600 leading-relaxed whitespace-pre-line mb-2">
                                {event.desc}
                              </div>

                              {/* Plans (Like Day 1 Dinner) */}
                              {event.plans && (
                                <div className="space-y-2 mt-2 mb-2">
                                  {event.plans.map((p, i) => (
                                    <div key={i} className="text-xs bg-stone-50 p-2 rounded border border-stone-100">
                                      <span className="font-bold text-stone-700 block mb-0.5">{p.label}</span>
                                      <span className="text-stone-500">{p.text}</span>
                                    </div>
                                  ))}
                                </div>
                              )}

                              {/* Reservations */}
                              {event.reservation && (
                                <div className="mt-3 bg-red-50 text-red-700 text-xs p-2 rounded border border-red-100 font-mono whitespace-pre-line select-all">
                                  {event.reservation}
                                </div>
                              )}

                              {/* Warnings / Must Eat / Tips */}
                              <div className="space-y-1.5 mt-2">
                                {event.warning && (
                                  <div className="flex gap-1.5 items-start text-xs text-amber-700 font-medium">
                                    <AlertTriangle size={12} className="mt-0.5 shrink-0" />
                                    <span>{event.warning}</span>
                                  </div>
                                )}
                                {event.mustEat && (
                                  <div className="flex gap-1.5 items-start text-xs text-orange-600 font-bold">
                                    <Utensils size={12} className="mt-0.5 shrink-0" />
                                    <span>ÂøÖÂêÉÔºö{event.mustEat}</span>
                                  </div>
                                )}
                              </div>

                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}
                </div>
              ))}
              <div className="h-8"></div>
            </div>
          )}

          {/* --- INFO TAB --- */}
          {activeTab === 'info' && (
            <div className="p-4 space-y-8">
              {/* Flights */}
              <section>
                <SectionHeader icon={<Plane size={16}/>} title="Ëà™Áè≠Ë≥áÊñô" />
                <div className="space-y-3">
                  {tripData.flights.map((f, i) => (
                    <div key={i} className="bg-white p-4 rounded-xl border border-stone-200 shadow-sm relative">
                       <div className={`absolute top-0 left-0 bottom-0 w-1 ${f.type === 'Dep' ? 'bg-blue-500' : 'bg-green-500'}`} />
                       <div className="flex justify-between items-start mb-2">
                         <span className="text-xs font-bold text-stone-400 uppercase">{f.type === 'Dep' ? 'ÂéªÁ®ã (Departure)' : 'ÂõûÁ®ã (Return)'}</span>
                         <span className="text-xs font-mono font-bold text-stone-600">{f.date}</span>
                       </div>
                       <div className="flex justify-between items-center mb-1">
                         <span className="text-lg font-black text-stone-800">{f.code}</span>
                         <span className="text-sm font-mono text-stone-600">{f.time}</span>
                       </div>
                       <p className="text-sm text-stone-500 mb-2">{f.route}</p>
                       <div className="flex gap-2 text-xs text-stone-500 bg-stone-50 p-2 rounded">
                          <Briefcase size={12} className="mt-0.5"/> {f.loc} | {f.baggage}
                       </div>
                    </div>
                  ))}
                </div>
              </section>

              {/* Hotels */}
              <section>
                <SectionHeader icon={<Hotel size={16}/>} title="‰ΩèÂÆøË©≥ÊÉÖ" />
                <div className="space-y-4">
                  {tripData.hotels.map((h, i) => (
                    <div key={i} className="bg-white rounded-xl border border-stone-200 shadow-sm overflow-hidden">
                       <div className="bg-stone-50 p-3 border-b border-stone-100 flex justify-between items-center">
                          <span className="text-xs font-bold text-stone-500">{h.dates}</span>
                          <span className="text-xs font-mono text-stone-400">{h.price}</span>
                       </div>
                       <div className="p-4">
                          <div className="flex justify-between items-start mb-1">
                            <h4 className="font-bold text-stone-800 text-sm leading-tight pr-2">{h.name}</h4>
                            <button onClick={() => openMap(h.name)}><Navigation size={16} className="text-stone-300 hover:text-blue-500"/></button>
                          </div>
                          <p className="text-xs text-stone-500 mb-3">{h.address}</p>
                          <div className="text-xs bg-yellow-50 text-yellow-800 p-2 rounded border border-yellow-100">
                             {h.note}
                          </div>
                       </div>
                    </div>
                  ))}
                </div>
              </section>

              {/* Emergency */}
              <section>
                <SectionHeader icon={<Phone size={16}/>} title="Á∑äÊÄ•ËÅØÁµ°" />
                <div className="grid grid-cols-1 gap-3">
                  {tripData.contacts.map((c, i) => (
                    <div key={i} className="flex justify-between items-center bg-red-50 p-3 rounded-lg border border-red-100">
                       <span className="text-xs font-bold text-red-400">{c.title}</span>
                       <span className="text-lg font-mono font-bold text-red-700">{c.num}</span>
                    </div>
                  ))}
                </div>
              </section>

              {/* Luggage Note */}
              <section>
                 <SectionHeader icon={<Briefcase size={16}/>} title="Ë°åÊùéÁ≠ñÁï•" />
                 <div className="bg-white p-4 rounded-xl border border-stone-200 text-sm text-stone-600 space-y-2">
                    <p>‚Ä¢ 30 ÂêãÔºöLOJEL Cubo Fit (ÂâçÈñã)</p>
                    <p>‚Ä¢ 27.6 ÂêãÔºöRIMOWA Check-In M (Â∞çÈñã)</p>
                    <p>‚Ä¢ 21 ÂêãÔºöLOJEL Cubo Small (ÂâçÈñã)</p>
                    <div className="mt-2 pt-2 border-t border-stone-100 text-xs text-stone-400">
                      * 1/8 ËΩâÂÆøÊó•Ôºö‰∏â‰ª∂Ë°åÊùéÂÖ®ÈÉ®Ë∑üË∫´
                    </div>
                 </div>
              </section>
            </div>
          )}

          {/* --- BUDGET TAB --- */}
          {activeTab === 'budget' && (
             <div className="p-4 space-y-6">
                
                {/* 1. Remaining Budget Card */}
                <div className="bg-stone-800 text-stone-50 rounded-2xl p-6 shadow-xl relative overflow-hidden">
                   <div className="relative z-10">
                    <p className="text-[10px] text-stone-400 uppercase tracking-widest mb-1">Remaining Budget</p>
                    <div className="flex items-baseline gap-2">
                       <div className="text-3xl font-mono font-bold">¬•{(totalBudget - currentSpent).toLocaleString()}</div>
                       <div className="text-sm font-mono text-stone-400">({formatHKD(totalBudget - currentSpent)})</div>
                    </div>
                    
                    <div className="w-full bg-stone-700 h-1 rounded-full mt-4 overflow-hidden">
                      <div className="bg-white h-full" style={{ width: `${(currentSpent / totalBudget) * 100}%` }}></div>
                    </div>
                    <div className="flex justify-between mt-2 text-[10px] text-stone-400 font-mono">
                       <div className="flex flex-col">
                         <span>USED: ¬•{currentSpent.toLocaleString()}</span>
                         <span className="text-stone-500">({formatHKD(currentSpent)})</span>
                       </div>
                       <div className="flex flex-col text-right">
                         <span>TOTAL: ¬•{totalBudget.toLocaleString()}</span>
                         <span className="text-stone-500">({formatHKD(totalBudget)})</span>
                       </div>
                    </div>
                   </div>
                </div>

                {/* 2. Expenses Analysis (Pie Chart) */}
                {currentSpent > 0 && (
                  <div className="bg-white p-4 rounded-xl border border-stone-200 shadow-sm">
                    <h3 className="text-xs font-bold text-stone-400 uppercase mb-4 flex items-center gap-2">
                      <PieChartIcon size={14}/> Ê∂àË≤ªÂàÜ‰Ωà
                    </h3>
                    
                    <div className="flex flex-col sm:flex-row items-center gap-6">
                      {/* Pie Chart with Icons */}
                      <div className="relative w-36 h-36 mx-auto sm:mx-0 shrink-0">
                        {/* The Gradient Circle */}
                        <div 
                          className="w-full h-full rounded-full shadow-inner border-4 border-white"
                          style={{ background: pieGradient }}
                        />
                        
                        {/* Overlay Icons */}
                        {chartData.map((cat) => {
                          // Only show icon if slice is big enough (> 8%)
                          if (cat.percent < 8) return null;
                          
                          // Calculate rotation: 0% is at 12 o'clock (0deg)
                          const rotation = cat.midPercent * 3.6;
                          
                          return (
                            <div
                              key={cat.key}
                              className="absolute top-0 left-0 w-full h-full flex items-center justify-center pointer-events-none"
                              style={{ 
                                transform: `rotate(${rotation}deg)` 
                              }}
                            >
                              <div 
                                className="flex items-center justify-center drop-shadow-md"
                                style={{ 
                                  transform: `translateY(-42px) rotate(-${rotation}deg)` 
                                }}
                              >
                                <cat.icon size={16} className="text-white" strokeWidth={2.5} />
                              </div>
                            </div>
                          );
                        })}
                      </div>
                      
                      {/* Legend */}
                      <div className="flex-1 w-full space-y-3">
                        {chartData.map((cat) => (
                           <div key={cat.key} className="flex justify-between items-center border-b border-stone-50 pb-2 last:border-0 last:pb-0">
                              <div className="flex items-center gap-2">
                                {/* Icon with light background */}
                                <div 
                                  className="w-8 h-8 rounded-full flex items-center justify-center shrink-0" 
                                  style={{ backgroundColor: `${cat.color}15` }} // 15% opacity background
                                >
                                   <cat.icon size={14} style={{ color: cat.color }} />
                                </div>
                                <div className="flex flex-col">
                                   <span className="text-xs font-bold text-stone-700 leading-tight">{cat.label}</span>
                                   <span className="text-[10px] text-stone-400 font-mono leading-tight">{Math.round(cat.percent)}%</span>
                                </div>
                              </div>
                              
                              <div className="text-right">
                                 <div className="text-xs font-mono font-bold text-stone-800">¬•{cat.amount.toLocaleString()}</div>
                                 <div className="text-[10px] font-mono text-stone-400">{formatHKD(cat.amount)}</div>
                              </div>
                           </div>
                        ))}
                      </div>
                    </div>
                  </div>
                )}

                {/* 3. Add Expense Form */}
                <div className="bg-white p-4 rounded-xl border border-stone-200 shadow-sm">
                   <h3 className="text-xs font-bold text-stone-400 uppercase mb-3">Add Expense</h3>
                   
                   {/* Inputs */}
                   <div className="space-y-2 mb-3">
                     <div className="flex gap-2">
                       {/* Category Selector */}
                       <div className="relative w-[35%]">
                         <select 
                           className="w-full appearance-none bg-stone-50 border border-stone-200 rounded px-2 py-2 text-sm focus:outline-none focus:border-stone-400"
                           value={newExpCategory}
                           onChange={(e) => setNewExpCategory(e.target.value)}
                         >
                            {Object.entries(CATEGORY_CONFIG).map(([key, config]) => (
                              <option key={key} value={key}>{config.label}</option>
                            ))}
                         </select>
                         <ChevronDown size={14} className="absolute right-2 top-3 text-stone-400 pointer-events-none"/>
                       </div>

                       {/* Currency & Amount Group */}
                       <div className="flex-1 flex gap-1">
                          <select 
                            value={newExpCurrency} 
                            onChange={(e) => setNewExpCurrency(e.target.value)}
                            className="bg-stone-50 border border-stone-200 rounded px-1 py-2 text-sm font-mono focus:outline-none focus:border-stone-400"
                          >
                            <option value="JPY">¬•</option>
                            <option value="HKD">HK$</option>
                          </select>
                          <input 
                            type="number" 
                            placeholder={newExpCurrency === 'JPY' ? "0" : "0"} 
                            className="flex-1 bg-stone-50 border border-stone-200 rounded px-2 py-2 text-sm focus:outline-none focus:border-stone-400 font-mono"
                            value={newExpAmount}
                            onChange={(e) => setNewExpAmount(e.target.value)}
                          />
                       </div>
                     </div>
                     <input 
                       type="text" 
                       placeholder="Item Name (e.g. Dinner)" 
                       className="w-full bg-stone-50 border border-stone-200 rounded px-3 py-2 text-sm focus:outline-none focus:border-stone-400"
                       value={newExpTitle}
                       onChange={(e) => setNewExpTitle(e.target.value)}
                     />
                   </div>

                   <button 
                     onClick={handleAddExpense}
                     className="w-full bg-stone-800 text-white text-xs font-bold py-3 rounded hover:bg-stone-700 active:scale-95 transition-all flex justify-center items-center gap-2"
                   >
                     <CreditCard size={14}/> ADD RECORD
                   </button>
                </div>

                {/* 4. Transaction List */}
                <div className="space-y-2">
                  <h3 className="text-xs font-bold text-stone-400 uppercase pl-1">Recent Transactions</h3>
                  {expenses.slice().reverse().map((ex) => {
                    const catConfig = CATEGORY_CONFIG[ex.cat] || CATEGORY_CONFIG.other;
                    return (
                      <div key={ex.id} className="bg-white p-3 rounded-lg border border-stone-100 flex justify-between items-center shadow-sm group">
                        <div className="flex items-center gap-3">
                          <button 
                            onClick={() => handleDeleteExpense(ex.id)}
                            className="text-stone-300 hover:text-red-500 transition-colors p-1 -ml-1"
                          >
                            <Trash2 size={14} />
                          </button>
                          
                          {/* Category Dot */}
                          <div className="w-8 h-8 rounded-full bg-stone-50 flex items-center justify-center text-stone-400 border border-stone-100">
                             <catConfig.icon size={14} style={{ color: catConfig.color }}/>
                          </div>

                          <div>
                             <div className="text-sm font-medium text-stone-700">{ex.title}</div>
                             <div className="text-[10px] text-stone-400" style={{ color: catConfig.color }}>{catConfig.label}</div>
                          </div>
                        </div>
                        <div className="text-right">
                          <div className="font-mono text-sm font-bold text-stone-900">¬•{ex.amount.toLocaleString()}</div>
                          <div className="font-mono text-[10px] text-stone-400">{formatHKD(ex.amount)}</div>
                        </div>
                      </div>
                    );
                  })}
                </div>
             </div>
          )}

          {/* --- MAP TAB --- */}
          {activeTab === 'map' && (
            <div className="flex flex-col h-full bg-stone-50">
              {/* Map Embed (Fixed Top) */}
              <div id="map-preview-container" className="h-[300px] w-full shrink-0 border-b border-stone-200 bg-stone-100 relative shadow-sm">
                 <iframe 
                   width="100%" 
                   height="100%" 
                   frameBorder="0" 
                   src={`https://maps.google.com/maps?q=${encodeURIComponent(mapLocation)}&t=&z=15&ie=UTF8&iwloc=&output=embed`}
                   className="grayscale-[0.2]"
                   title="Map View"
                 ></iframe>
                 <div className="absolute bottom-2 right-2 bg-white/90 backdrop-blur px-3 py-1.5 rounded-lg text-xs font-bold shadow-sm border border-stone-200 flex items-center gap-2">
                   <MapPin size={12} className="text-red-500" />
                   {mapLocation}
                 </div>
              </div>
              
              {/* List Container */}
              <div className="flex-1 overflow-y-auto p-4 space-y-6 bg-stone-100/30">
                <div className="flex items-center justify-between">
                   <h2 className="text-lg font-bold text-stone-800 flex items-center gap-2">
                     <MapIcon size={20} /> Âú∞ÈªûÁ∏ΩË¶Ω
                   </h2>
                   <span className="text-[10px] text-stone-400">ÈªûÊìäÂú∞Èªû‰ª•È†êË¶Ω</span>
                </div>

                {tripData.days.map((day) => (
                  <div key={day.id} className="relative">
                    {/* Day Sticky Header */}
                    <div className="sticky top-0 z-10 bg-stone-200/90 backdrop-blur-sm py-1.5 px-3 rounded-md mb-2 flex justify-between items-center">
                       <span className="text-xs font-bold text-stone-600">{day.date}</span>
                       <span className="text-[10px] text-stone-400">{day.title}</span>
                    </div>

                    <div className="space-y-2 pl-2 border-l-2 border-stone-200 ml-2">
                       {day.events.map((ev, idx) => (
                         <div 
                           key={idx} 
                           onClick={() => handleLocClick(ev.loc)}
                           className={`bg-white p-3 rounded-lg border shadow-sm flex justify-between items-center cursor-pointer transition-all active:scale-95 ${mapLocation === ev.loc ? 'border-blue-500 ring-1 ring-blue-500/20' : 'border-stone-100 hover:border-blue-300'}`}
                         >
                            <div className="flex items-center gap-3 overflow-hidden">
                              <div className={`shrink-0 w-8 h-8 rounded-full flex items-center justify-center ${mapLocation === ev.loc ? 'bg-blue-100 text-blue-600' : 'bg-stone-50 text-stone-400'}`}>
                                <CategoryIcon type={ev.type} />
                              </div>
                              <div className="truncate">
                                <div className="text-sm font-bold text-stone-800 truncate pr-2">{ev.title.split('Ôºö')[0]}</div>
                                <div className="text-[10px] text-stone-400 truncate">{ev.loc}</div>
                              </div>
                            </div>
                            <button 
                              onClick={(e) => { e.stopPropagation(); openMap(ev.loc); }}
                              className="shrink-0 p-2 text-stone-300 hover:text-blue-500"
                            >
                               <ExternalLink size={16} />
                            </button>
                         </div>
                       ))}
                    </div>
                  </div>
                ))}
                
                <div className="h-8"></div>
              </div>
            </div>
          )}

        </main>

        {/* Navigation Bar */}
        <nav className="bg-white border-t border-stone-200 pb-safe pt-1 px-4 flex justify-between items-center h-[75px] z-40">
          <button 
            onClick={() => setActiveTab('itinerary')}
            className={`flex flex-col items-center gap-1 p-2 rounded-xl transition-all w-16 ${activeTab === 'itinerary' ? 'bg-stone-100 text-stone-900' : 'text-stone-400'}`}
          >
            <Calendar size={22} strokeWidth={activeTab === 'itinerary' ? 2.5 : 2} />
            <span className="text-[10px] font-bold">Trip</span>
          </button>
          
          <button 
             onClick={() => setActiveTab('info')}
             className={`flex flex-col items-center gap-1 p-2 rounded-xl transition-all w-16 ${activeTab === 'info' ? 'bg-stone-100 text-stone-900' : 'text-stone-400'}`}
          >
            <BookOpen size={22} strokeWidth={activeTab === 'info' ? 2.5 : 2} />
            <span className="text-[10px] font-bold">Info</span>
          </button>

          <button 
             onClick={() => setActiveTab('budget')}
             className={`flex flex-col items-center gap-1 p-2 rounded-xl transition-all w-16 ${activeTab === 'budget' ? 'bg-stone-100 text-stone-900' : 'text-stone-400'}`}
          >
            <CreditCard size={22} strokeWidth={activeTab === 'budget' ? 2.5 : 2} />
            <span className="text-[10px] font-bold">Budget</span>
          </button>

          <button 
             onClick={() => setActiveTab('map')}
             className={`flex flex-col items-center gap-1 p-2 rounded-xl transition-all w-16 ${activeTab === 'map' ? 'bg-stone-100 text-stone-900' : 'text-stone-400'}`}
          >
            <MapIcon size={22} strokeWidth={activeTab === 'map' ? 2.5 : 2} />
            <span className="text-[10px] font-bold">Map</span>
          </button>
        </nav>

      </div>
    </div>
  );
}